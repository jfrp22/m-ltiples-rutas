<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Dispositivos IoT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
    <style>
        .device-card { transition: all 0.3s; margin-bottom: 15px; }
        .device-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .online { border-left: 5px solid #28a745 !important; }
        .offline { border-left: 5px solid #dc3545 !important; }
        .signal-weak { color: #ffc107; }
        .signal-good { color: #28a745; }
        #lastUpdate { font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="mb-4">üõ†Ô∏è Monitor de Dispositivos</h1>
        
        <div class="row mb-4">
            <div class="col-md-6">
                <input type="text" id="searchInput" class="form-control" placeholder="Filtrar por MAC o IP...">
            </div>
            <div class="col-md-6 text-end">
                <span id="lastUpdate" class="text-muted"></span>
            </div>
        </div>
        
        <div id="devicesContainer" class="row">
            <!-- Las tarjetas se generan din√°micamente aqu√≠ -->
        </div>
    </div>

    <script>
        const devices = {};
        const client = mqtt.connect("wss://test.mosquitto.org:8081/mqtt");

        // Plantilla para tarjeta de dispositivo
        function createDeviceCard(device) {
            const isOnline = (new Date() - new Date(device.lastSeen)) < 120000;
            const signalStrength = getSignalStrength(device.rssi);
            
            return `
                <div class="col-md-4">
                    <div class="card device-card ${isOnline ? 'online' : 'offline'}">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="bi bi-${isOnline ? 'check-circle' : 'x-circle'}"></i>
                                ${device.mac}
                            </h5>
                            <table class="table table-sm">
                                <tr><th>IP:</th><td>${device.ip || 'N/A'}</td></tr>
                                <tr><th>Se√±al:</th><td class="${signalStrength.class}">
                                    ${signalStrength.text} (${device.rssi} dBm)
                                </td></tr>
                                <tr><th>Uptime:</th><td>${formatUptime(device.uptime)}</td></tr>
                                <tr><th>√öltima vez:</th><td>${new Date(device.lastSeen).toLocaleTimeString()}</td></tr>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function getSignalStrength(rssi) {
            if (rssi >= -60) return { text: "Fuerte", class: "signal-good" };
            if (rssi >= -80) return { text: "Moderada", class: "" };
            return { text: "D√©bil", class: "signal-weak" };
        }

        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            seconds %= 86400;
            const hours = Math.floor(seconds / 3600);
            seconds %= 3600;
            const mins = Math.floor(seconds / 60);
            return `${days}d ${hours}h ${mins}m`;
        }

        client.on('connect', () => {
            client.subscribe("iot/dispositivos/metricas");
            console.log("Conectado al broker MQTT");
        });

        client.on('message', (topic, message) => {
            try {
                const data = JSON.parse(message.toString());
                if (!data.mac) return;
                
                devices[data.mac] = {
                    ...data,
                    lastSeen: new Date()
                };
                
                updateUI();
            } catch (e) {
                console.error("Error procesando mensaje:", e);
            }
        });

        function updateUI() {
            const container = document.getElementById('devicesContainer");
            const searchTerm = document.getElementById('searchInput").value.toLowerCase();
            
            // Filtrar y ordenar dispositivos
            const filteredDevices = Object.values(devices)
                .filter(device => 
                    device.mac.toLowerCase().includes(searchTerm) || 
                    (device.ip && device.ip.includes(searchTerm)))
                .sort((a, b) => new Date(b.lastSeen) - new Date(a.lastSeen));
            
            // Generar HTML
            container.innerHTML = filteredDevices.map(createDeviceCard).join('');
            
            // Actualizar timestamp
            document.getElementById('lastUpdate").textContent = 
                `√öltima actualizaci√≥n: ${new Date().toLocaleTimeString()}`;
        }

        // B√∫squeda en tiempo real
        document.getElementById('searchInput").addEventListener('input', updateUI);
        
        // Actualizar cada 15 segundos (para detectar offline)
        setInterval(updateUI, 15000);
    </script>
</body>
</html>
