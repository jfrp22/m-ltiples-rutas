<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Servomotor MQTT</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        h1 {
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        #connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            margin-top: 10px;
        }
        
        .connected {
            background-color: var(--success);
            color: white;
        }
        
        .disconnected {
            background-color: var(--danger);
            color: white;
        }
        
        .servo-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .servo-slider {
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: linear-gradient(to right, var(--danger), var(--success));
            outline: none;
            margin: 20px 0;
            -webkit-appearance: none;
        }
        
        .servo-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .servo-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            margin: 10px 0;
        }
        
        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }
        
        .btn:hover {
            background-color: var(--secondary);
        }
        
        @media (max-width: 600px) {
            body {
                padding: 15px;
            }
            
            .servo-card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-robot"></i> Control de Servomotor</h1>
            <div id="connection-status" class="disconnected">
                <i class="fas fa-plug"></i> Desconectado
            </div>
        </header>
        
        <div class="servo-card">
            <h3><i class="fas fa-cog"></i> Posición del Servo</h3>
            <input type="range" min="0" max="180" value="90" class="servo-slider" id="servo-control">
            <div class="servo-value" id="servo-value">90°</div>
            <button class="btn" onclick="centerServo()">
                <i class="fas fa-align-center"></i> Centrar
            </button>
        </div>
        
        <div class="connection-info">
            <p><strong>Configuración:</strong></p>
            <p>Broker: <span id="broker-info">test.mosquitto.org</span></p>
            <p>Tema: <span id="topic-info">iot/servos/control</span></p>
        </div>
    </div>

    <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
    <script>
        // Configuración MQTT
        const mqttOptions = {
            clean: true,
            connectTimeout: 4000,
            clientId: 'web-client-' + Math.random().toString(16).substr(2, 8),
        };
        
        const client = mqtt.connect("wss://test.mosquitto.org:8081/mqtt", mqttOptions);
        const topic = "iot/servos/control";
        
        // Elementos UI
        const statusElement = document.getElementById("connection-status");
        const slider = document.getElementById("servo-control");
        const valueDisplay = document.getElementById("servo-value");
        
        // Eventos MQTT
        client.on('connect', () => {
            updateStatus('connected', '<i class="fas fa-plug"></i> Conectado al broker');
            console.log("Conectado a MQTT");
        });
        
        client.on('error', (err) => {
            updateStatus('error', '<i class="fas fa-exclamation-triangle"></i> Error de conexión');
            console.error("Error MQTT:", err);
        });
        
        client.on('offline', () => {
            updateStatus('disconnected', '<i class="fas fa-plug"></i> Desconectado');
        });
        
        // Control del servo
        slider.addEventListener('input', () => {
            const angle = slider.value;
            valueDisplay.textContent = `${angle}°`;
            sendServoPosition(angle);
        });
        
        function sendServoPosition(angle) {
            const message = JSON.stringify({
                device: 'servo1',
                angle: parseInt(angle),
                timestamp: new Date().toISOString()
            });
            
            client.publish(topic, message, { qos: 1 }, (err) => {
                if (!err) {
                    console.log("Ángulo enviado:", angle);
                } else {
                    console.error("Error al enviar:", err);
                }
            });
        }
        
        function centerServo() {
            slider.value = 90;
            slider.dispatchEvent(new Event('input'));
        }
        
        function updateStatus(status, text) {
            statusElement.className = status;
            statusElement.innerHTML = text;
            
            // Actualizar colores según estado
            if (status === 'connected') {
                statusElement.classList.add('connected');
                statusElement.classList.remove('disconnected');
            } else {
                statusElement.classList.add('disconnected');
                statusElement.classList.remove('connected');
            }
        }
        
        // Inicialización
        window.addEventListener('DOMContentLoaded', () => {
            valueDisplay.textContent = `${slider.value}°`;
        });
    </script>
</body>
</html>
